<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			body{
				background: #333666;
				color: white;
				font-family: Helvetica;
			}
		</style>
		<title>
			1712874_BTVN7
		</title>
		<script src="edgeDetection.js"></script>
		<script>
			function startFilter(){
				var rect;
				var width;
				var height;
				var context;
				var inited = false;
				function grayscale(data, context){
					var pixels = data.data;
					var width = data.width;
					var length = pixels.length;
					var abs = Math.abs;
					var j = -1;
					for(var i = -1; i < length - 1 - width*4; ){
						var r = pixels[++i];
						var g = pixels[++i];
						var b = pixels[++i];
						var value = 0.3*r + 0.59*g + 0.11*b;
						pixels[++j] = value;
						pixels[++j] = value;
						pixels[++j] = value;
						++i;
						++j;
					}
					return data;
				}
				function edgeDetector(){
  
  // Variables
  this.img = undefined;
  this.imgElement = undefined;
  this.ctx = undefined;
  this.canvasElement = undefined;
  this.rawCanvas = undefined;
  this.rawctx = undefined;
  this.ctxDimensions = {
    width: undefined,
    height:undefined
  };
  this.pixelData = undefined;
  this.threshold = 30;
  this.pointerColor = 'rgba(255,0,0,1)';
  
  
  this.init = function(){
    // Build the canvas
    var width = $(this.imgElement).width();
    var height = $(this.imgElement).height();
    $("<canvas id=\"rawData\" width=\""+width+"\" height=\""+height+"\"></canvas>").insertAfter(this.imgElement);
    $("<canvas id=\"layer\" width=\""+width+"\" height=\""+height+"\"></canvas>").insertAfter(this.imgElement);

    this.canvasElement = $("#layer")[0];
    this.rawCanvas = $("#rawData")[0];
    this.ctx = this.canvasElement.getContext('2d');
    this.rawctx = this.rawCanvas.getContext('2d');

    // Store the Canvas Size
    this.ctxDimensions.width = width;
    this.ctxDimensions.height = height;
  };
  
  this.findEdges = function(){
    this.copyImage();
    this.coreLoop();
  };
  
  this.copyImage = function(){
    this.rawctx.clearRect(0,0,this.ctxDimensions.width,this.ctxDimensions.height);
    this.ctx.drawImage(this.imgElement,0,0);

    //Grab the Pixel Data, and prepare it for use
    this.pixelData = this.ctx.getImageData(0,0,this.ctxDimensions.width, this.ctxDimensions.height);
  };
  
  this.coreLoop = function(){
    var x = 0;
    var y = 0;

    var left = undefined;
    var top = undefined;
    var right = undefined;
    var bottom = undefined;

    for(y=0;y<this.pixelData.height;y++){
        for(x=0;x<this.pixelData.width;x++){
            // get this pixel's data
            // currently, we're looking at the blue channel only.
            // Since this is a B/W photo, all color channels are the same.
            // ideally, we would make this work for all channels for color photos.
            index = (x + y * this.ctxDimensions.width) * 4;
            pixel = this.pixelData.data[index+2];

            // Get the values of the surrounding pixels
            // Color data is stored [r,g,b,a][r,g,b,a]
            // in sequence.
            left = this.pixelData.data[index-4];
            right = this.pixelData.data[index+2];
            top = this.pixelData.data[index-(this.ctxDimensions.width*4)];
            bottom = this.pixelData.data[index+(this.ctxDimensions.width*4)];

            //Compare it all.
            // (Currently, just the left pixel)
            if(pixel>left+this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel<left-this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel>right+this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel<right-this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel>top+this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel<top-this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel>bottom+this.threshold){
                this.plotPoint(x,y);
            }
            else if(pixel<bottom-this.threshold){
                this.plotPoint(x,y);
            }
        }
    }
  };
  
  this.plotPoint = function(x,y){
      this.ctx.beginPath();
      this.ctx.arc(x, y, 0.5, 0, 2 * Math.PI, false);
      this.ctx.fillStyle = 'green';
      this.ctx.fill();
      this.ctx.beginPath();

      // Copy onto the raw canvas
      // this is probably the most useful application of this,
      // as you would then have raw data of the edges that can be used.

      this.rawctx.beginPath();
      this.rawctx.arc(x, y, 0.5, 0, 2 * Math.PI, false);
      this.rawctx.fillStyle = 'green';
      this.rawctx.fill();
      this.rawctx.beginPath();
  };
}
				function updateFrame(){
					try{
						if(!inited){
							if(!video.videoWidth) return;
							inited = true;
							width = canvas.width = video.videoWidth;
							height = canvas.height = video.videoHeight;
							context = canvas.getContext("2d");
							rect = {x:0, y:0, width: width, height: height};
						}
						fps++;
						try{context.drawImage(video,0,0,width,height); } catch(e) {}
						if(!rect)
							return;
						var rx = rect.x;
						var ry = rect.y;
						var rw = rect.width;
						var rh = rect.height
						if(rw < 0){
							rx += rw;
							rw = -rw;
						}
						if(rh < 0){
							ry += rh;
							rh = -rh;
						}
						var data = context.getImageData(rx,ry,rw,rh);
						data = edgeDetector(data,context);
						context.putImageData(data,rx,ry);
					}finally{
						setTimeout(updateFrame,15);
					}
				}
				setTimeout(updateFrame,10);
				var canvas = document.getElementById("canvas");
				var pressed = false;
				canvas.onmousedown = function(event){
					var tRect = event.target.getClientRects()[0];
					rect = {x: event.clientX - tRect.left,
							y: event.clientY - tRect.top,
							width: 1, height: 1};
					pressed = true;
				}
				canvas.onmouseup = function(event){
					pressed = false;
				}
				canvas.onmousemove = function(event){
					if(!rect || !pressed){ return; }
					var tRect = event.target.getClientRects()[0];
					rect.width = event.clientX - tRect.left - rect.x;
					rect.height = event.clientY - tRect.top - rect.y;
				}
				var fps = 0;
				setInterval(function(){
					document.getElementById("fps").innerHTML = fps + "(" + [width,height] + ")"; fps = 0;
				}, 1000);
			}
			var video;
			window.onload = function(){
				video = document.createElement("video");
				video.controls = true;
				video.autoplay = true;
				var movSource = document.createElement("source");
				movSource.src = "topi.mp4";
				// var oggSource = document.createElement("source");
				//oggSource.src = "topi.ogg";
				video.appendChild(movSource);
				//video.appendChild(oggSource);
				video.loop = true;
				try{ video.load();} catch(e){}
				document.getElementById("displayCell").appendChild(video);
				startFilter();
			}
		</script>
	</head>
	<body>
		<table style="width: 100%;">
			<tbody>
				<tr>
					<td style="text-align: center">
						<h1>Nguyen Chanh Anh Tuan - 1712874</h1>
						<h2>BTVN7 - Lop DHUD 17_22</h2>
					</td>
				</tr>
			</tbody>
		</table>
		<div>
			<span id="displayCell">
				<video controls="" autoplay="" loop"">
					<source src = "topi.mp4">
					<!-- <source src = "topi.ogg"> -->
				</video>
			</span>
			&nbsp;
			<canvas id="canvas" width="320" height="240">
			</canvas>
			<div>
				Framerate:
				<span id="fps">50(320,240)</span>
			</div>
		</div>
	</body>
</html>